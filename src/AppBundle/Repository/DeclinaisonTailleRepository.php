<?php

namespace AppBundle\Repository;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\QueryBuilder;
/**
 * DeclinaisonTailleRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class DeclinaisonTailleRepository extends EntityRepository
{


    public function findProduitsByTaille_Famille($idTaille, $idFamille){
        $queryBuilder = $this->createQueryBuilder('t');
        $queryBuilder->join('t.produit', 'p')
            ->addSelect('p')
            ->where($queryBuilder->expr()->eq('p.famille', ':idFamille'))
            ->andWhere($queryBuilder->expr()->eq('t.taille', ':idTaille'))
            ->setParameters(array('idFamille' => $idFamille, 'idTaille' => $idTaille))
        ;

        return $queryBuilder
            ->getQuery()
            ->getResult();
    }

    public function findProduitsFiltreTaille($arrayTaille){

        $tailleSplit = explode(",", $arrayTaille);

        $queryBuilder = $this->createQueryBuilder('t');
        $queryBuilder->join('t.produit', 'p')
            ->addSelect('p');

        $idTaille=0;
        $orXTaille = $queryBuilder->expr()->orX();

        foreach ($tailleSplit as  $taille) {
            $orXTaille->add($queryBuilder->expr()->eq('t.taille', ":taille_".$idTaille));
            $queryBuilder->setParameter("taille_".$idTaille, $taille);
            $idTaille++;
        }
        $queryBuilder->andWhere($orXTaille);

        return $queryBuilder
            ->getQuery()
            ->getResult();
    }



    public function findProduitsFiltres($arrayTaille, $arrayMarque){

        $tailleSplit = explode(",", $arrayTaille);
        $marqueSplit = explode(",", $arrayMarque);

        $queryBuilder = $this->createQueryBuilder('t');
        $queryBuilder->join('t.produit', 'p')
            ->addSelect('p');

        $idTaille=0;
        $idMarque=0;
        $orXTaille = $queryBuilder->expr()->orX();
        $orXMarque = $queryBuilder->expr()->orX();

        foreach ($tailleSplit as  $taille) {
            $orXTaille->add($queryBuilder->expr()->eq('t.taille', ":taille_".$idTaille));
            $queryBuilder->setParameter("taille_".$idTaille, $taille);
            $idTaille++;
        }
        $queryBuilder->andWhere($orXTaille);

        foreach ($marqueSplit as  $marque) {
            $orXMarque->add($queryBuilder->expr()->eq('p.fournisseur', ":marque_".$idMarque));
            $queryBuilder->setParameter("marque_".$idMarque, $marque);
            $idMarque++;
        }


        $queryBuilder->andWhere($orXMarque);

        return $queryBuilder
            ->getQuery()
            ->getResult();
    }

    public function findProduitsFiltresFemmes($arrayTaille, $arrayMarque){

        $tailleSplit = explode(",", $arrayTaille);
        $marqueSplit = explode(",", $arrayMarque);

        $queryBuilder = $this->createQueryBuilder('t');
        $queryBuilder->join('t.produit', 'p')
            ->join('p.famille', 'f')
            ->addSelect('p')
            ->where($queryBuilder->expr()->eq('f.sexe',$queryBuilder->expr()->literal("F")));

        $idTaille=0;
        $idMarque=0;
        $orXTaille = $queryBuilder->expr()->orX();
        $orXMarque = $queryBuilder->expr()->orX();

        foreach ($tailleSplit as  $taille) {
            $orXTaille->add($queryBuilder->expr()->eq('t.taille', ":taille_".$idTaille));
            $queryBuilder->setParameter("taille_".$idTaille, $taille);
            $idTaille++;
        }
        $queryBuilder->andWhere($orXTaille);

        foreach ($marqueSplit as  $marque) {
            $orXMarque->add($queryBuilder->expr()->eq('p.fournisseur', ":marque_".$idMarque));
            $queryBuilder->setParameter("marque_".$idMarque, $marque);
            $idMarque++;
        }


        $queryBuilder->andWhere($orXMarque);

        return $queryBuilder
            ->getQuery()
            ->getResult();
    }

    public function findProduitsFiltreTailleFemmes($arrayTaille){

        $tailleSplit = explode(",", $arrayTaille);

        $queryBuilder = $this->createQueryBuilder('t');
        $queryBuilder->join('t.produit', 'p')
        ->join('p.famille', 'f')
            ->addSelect('p')
            ->where($queryBuilder->expr()->eq('f.sexe',$queryBuilder->expr()->literal("F")));

        $idTaille=0;
        $orXTaille = $queryBuilder->expr()->orX();

        foreach ($tailleSplit as  $taille) {
            $orXTaille->add($queryBuilder->expr()->eq('t.taille', ":taille_".$idTaille));
            $queryBuilder->setParameter("taille_".$idTaille, $taille);
            $idTaille++;
        }
        $queryBuilder->andWhere($orXTaille);

        return $queryBuilder
            ->getQuery()
            ->getResult();
    }
}
